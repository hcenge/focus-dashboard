---
import Base from '@/layouts/Base.astro';
import Clock from '@/components/Clock.astro';
import WeekCalendar from '@/components/WeekCalendar.astro';
import Kanban from '@/components/Kanban.astro';
import db, { type Task } from '@/lib/db';

const keyId = Astro.locals.authKey.id;
const tasks = db.prepare('SELECT * FROM tasks WHERE key_id = ? ORDER BY status, position').all(keyId) as Task[];
---

<Base title="Focus">
  <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode" onclick="toggleTheme()">
    <svg class="sun-icon" viewBox="0 0 32 32"><path d="M16,12a4,4,0,1,1-4,4,4.0045,4.0045,0,0,1,4-4m0-2a6,6,0,1,0,6,6,6,6,0,0,0-6-6Z" transform="translate(0 .005)"/><path d="M6.854 5.375H8.854V10.333H6.854z" transform="rotate(-45 7.86 7.856)"/><path d="M2 15.005H7V17.005H2z"/><path d="M5.375 23.147H10.333V25.147H5.375z" transform="rotate(-45 7.86 24.149)"/><path d="M15 25.005H17V30.005H15z"/><path d="M23.147 21.668H25.147V26.626H23.147z" transform="rotate(-45 24.152 24.149)"/><path d="M25 15.005H30V17.005H25z"/><path d="M21.668 6.854H26.626V8.854H21.668z" transform="rotate(-45 24.152 7.856)"/><path d="M15 2.005H17V7.005H15z"/></svg>
    <svg class="moon-icon" viewBox="0 0 32 32"><path d="M13.5025,5.4136A15.0755,15.0755,0,0,0,25.096,23.6082a11.1134,11.1134,0,0,1-7.9749,3.3893c-.1385,0-.2782.0051-.4178,0A11.0944,11.0944,0,0,1,13.5025,5.4136M14.98,3a1.0024,1.0024,0,0,0-.1746.0156A13.0959,13.0959,0,0,0,16.63,28.9973c.1641.006.3282,0,.4909,0a13.0724,13.0724,0,0,0,10.702-5.5556,1.0094,1.0094,0,0,0-.7833-1.5644A13.08,13.08,0,0,1,15.8892,4.38,1.0149,1.0149,0,0,0,14.98,3Z"/></svg>
  </button>
  <div class="dashboard">
    <header class="header">
      <Clock />
      <WeekCalendar />
    </header>
    <main class="main">
      <Kanban tasks={tasks} keyId={keyId} />
    </main>
  </div>
</Base>

<style>
  .dashboard {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 32px);
    max-width: 800px;
    margin: 0 auto;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--light-gray);
    margin-bottom: 16px;
    min-height: 64px;
  }

  .main {
    flex: 1;
    min-height: 0;
  }

  .theme-toggle {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 100;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray);
  }

  .theme-toggle svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
  }

  .theme-toggle .moon-icon {
    display: none;
  }

  :global([data-theme="dark"]) .theme-toggle .sun-icon {
    display: none;
  }

  :global([data-theme="dark"]) .theme-toggle .moon-icon {
    display: block;
  }

  .theme-toggle:active {
    color: var(--fg);
  }

  @media (hover: hover) {
    .theme-toggle:hover {
      color: var(--fg);
    }
  }

  @media (max-width: 600px) {
    .theme-toggle {
      top: 12px;
      right: 12px;
    }
  }

  @media (max-width: 600px) {
    .dashboard {
      height: auto;
      min-height: calc(100vh - 24px);
    }

    .header {
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      min-height: auto;
      padding-bottom: 12px;
      margin-bottom: 12px;
    }

    .main {
      flex: none;
    }
  }
</style>
